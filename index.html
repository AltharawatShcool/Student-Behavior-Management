<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <!-- Excel Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            color: #333;
            direction: rtl;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, var(--primary), #1e3a8a);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo p {
            font-size: 0.8rem;
            opacity: 0.85;
            line-height: 1.4;
        }
        
        .menu {
            list-style: none;
        }
        
        .menu li {
            margin-bottom: 3px;
        }
        
        .menu a {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-right: 4px solid transparent;
        }
        
        .menu a:hover, .menu a.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-right-color: #fbbf24;
            color: white;
        }
        
        .menu i {
            margin-left: 12px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-right: 260px;
        }
        
        .header {
            background-color: white;
            padding: 18px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(30, 64, 175, 0.15);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .content {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .page-title {
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-title h2 {
            color: var(--primary);
            font-weight: 700;
            font-size: 2rem;
        }
        
        .title-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card.secondary {
            border-left-color: var(--secondary);
        }
        
        .stat-card.warning {
            border-left-color: var(--warning);
        }
        
        .stat-card.danger {
            border-left-color: var(--danger);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 12px 0;
            color: var(--primary);
        }
        
        .stat-card.secondary .stat-value {
            color: var(--secondary);
        }
        
        .stat-card.warning .stat-value {
            color: var(--warning);
        }
        
        .stat-card.danger .stat-value {
            color: var(--danger);
        }
        
        .stat-title {
            color: var(--gray);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .table-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .table-controls input, .table-controls select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .table-controls input:focus, .table-controls select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 6px rgba(30, 64, 175, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        th, td {
            padding: 14px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background-color: #f8fafc;
            font-weight: 700;
            color: var(--primary);
        }
        
        tr:hover {
            background-color: #f8fafc;
        }
        
        .status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        
        .status.regular {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status.warning {
            background-color: #fed7aa;
            color: #92400e;
        }
        
        .status.danger {
            background-color: #fecaca;
            color: #7f1d1d;
        }
        
        .status.archived {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(30, 64, 175, 0.15);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border-left: 4px solid;
        }
        
        .alert.success {
            background-color: #ecfdf5;
            border-left-color: var(--secondary);
            color: #065f46;
        }
        
        .alert.warning {
            background-color: #fffbeb;
            border-left-color: var(--warning);
            color: #92400e;
        }
        
        .alert.danger {
            background-color: #fef2f2;
            border-left-color: var(--danger);
            color: #7f1d1d;
        }
        
        .alert i {
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-title {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.4rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
            line-height: 1;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), #1e3a8a);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 450px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .login-logo p {
            color: var(--gray);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .login-box .btn {
            width: 100%;
            justify-content: center;
            margin-top: 24px;
        }
        
        .advanced-search {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: var(--gray);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-secondary {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { border-left: 4px solid var(--secondary); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--primary); }

        .import-preview {
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .preview-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: right;
            border: none;
        }

        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-table tr:hover {
            background: white;
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .import-stat {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .import-stat.success {
            border-left-color: var(--secondary);
        }

        .import-stat.error {
            border-left-color: var(--danger);
        }

        .import-stat.warning {
            border-left-color: var(--warning);
        }

        .import-stat strong {
            display: block;
            font-size: 1.8rem;
            margin: 10px 0;
            color: var(--primary);
        }

        .import-stat.success strong {
            color: var(--secondary);
        }

        .import-stat.error strong {
            color: var(--danger);
        }

        .import-stat.warning strong {
            color: var(--warning);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff, #f0fdf4);
            border: 2px dashed var(--primary);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #e0f2fe, #dcfce7);
            border-color: var(--secondary);
        }

        .file-input-label.active {
            background: linear-gradient(135deg, #dbeafe, #dcfce7);
            border-color: var(--secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            
            .main-content {
                margin-right: 220px;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .menu {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .menu li {
                margin-bottom: 0;
                flex-shrink: 0;
            }
            
            .menu a {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .page-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .page-title h2 {
                font-size: 1.5rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .table-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .table-controls input, .table-controls select {
                width: 100%;
            }

            .import-stats {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .content {
                padding: 15px;
            }
            
            .page-title h2 {
                font-size: 1.3rem;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .login-box {
                padding: 24px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <h1>ğŸšŒ</h1>
                <h2 style="margin-top: 10px; margin-bottom: 0;">Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ</h2>
                <p style="margin-top: 10px;">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø«Ø±ÙˆØ§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</p>
            </div>
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="container" id="appContainer" style="display: none;">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="sidebar">
            <div class="logo">
                <h1>ğŸšŒ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
                <p>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø«Ø±ÙˆØ§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</p>
            </div>
            <ul class="menu">
                <li><a class="menu-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></a></li>
                <li><a class="menu-link" data-page="students"><i class="fas fa-user-graduate"></i> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span></a></li>
                <li><a class="menu-link" data-page="warnings"><i class="fas fa-exclamation-triangle"></i> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</span></a></li>
                <li><a class="menu-link" data-page="reports"><i class="fas fa-chart-bar"></i> <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></a></li>
                <li><a onclick="logout()" style="cursor: pointer;"><i class="fas fa-sign-out-alt"></i> <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></a></li>
            </ul>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <div class="header">
                <div class="search-box">
                    <input type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." id="globalSearch" onkeyup="globalSearch()">
                </div>
                <div class="user-info">
                    <div>
                        <div class="user-name" id="userName">Ù…Ù†Ø³Ù‚ Ø§Ù„Ù†Ù‚Ù„</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="page active" id="dashboard">
                    <div class="page-title">
                        <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                    </div>
                    
                    <div id="dashboardAlert"></div>
                    
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-title">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                            <div class="stat-value" id="totalStudents">0</div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-title">âš ï¸ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                            <div class="stat-value" id="todayWarnings">0</div>
                        </div>
                        
                        <div class="stat-card danger">
                            <div class="stat-title">ğŸš« Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø«Ø§Ù„Ø«Ø©</div>
                            <div class="stat-value" id="thirdWarnings">0</div>
                        </div>
                        
                        <div class="stat-card secondary">
                            <div class="stat-title">ğŸ“ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù…Ø¤Ø±Ø´ÙØ©</div>
                            <div class="stat-value" id="archivedWarnings">0</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>âš ï¸ Ø¢Ø®Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h3>
                            <button class="btn btn-primary btn-sm" onclick="showPage('warnings')">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="recentWarningsTable">
                                    <tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="page" id="students">
                    <div class="page-title">
                        <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                        <div class="title-actions">
                            <button class="btn btn-primary" onclick="showAddStudentModal()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                            <button class="btn btn-secondary" onclick="showImportModal()"><i class="fas fa-file-excel"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„</button>
                            <button class="btn btn-warning" onclick="downloadTemplate()"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
                            <button class="btn btn-warning" onclick="exportStudentsToExcel()"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
                        </div>
                    </div>
                    
                    <div class="advanced-search">
                        <div class="form-row">
                            <input type="text" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³..." id="studentSearch" onkeyup="filterStudents()">
                            <select id="studentClassFilter" onchange="filterStudents()">
                                <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ --</option>
                                <option value="KG1">KG1</option>
                                <option value="KG2">KG2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                                <option value="Grade 10">Grade 10</option>
                                <option value="Grade 11">Grade 11</option>
                                <option value="Grade 12">Grade 12</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                            <span style="color: var(--gray); font-size: 0.9rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="studentCount">0</strong> Ø·Ø§Ù„Ø¨</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³</th>
                                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                                        <th>Ø§Ù„ØµÙ</th>
                                        <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                                        <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                                        <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯</th>
                                        <th>Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTable">
                                    <tr><td colspan="8" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª -->
                <div class="page" id="warnings">
                    <div class="page-title">
                        <h2>âš ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">âœï¸ Ø¥ØµØ¯Ø§Ø± Ø¥Ù†Ø°Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
                        </div>
                        
                        <form id="warningForm" onsubmit="issueWarning(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
                                    <select id="warningStudent" required>
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± *</label>
                                    <select id="warningType" required>
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ --</option>
                                        <option value="1">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø£ÙˆÙ„</option>
                                        <option value="2">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                        <option value="3">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± (Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©) *</label>
                                <select id="violationType" required>
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ --</option>
                                    <option value="Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù„Ø§Ø¦Ù‚">Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</option>
                                    <option value="Ø¥Ø²Ø¹Ø§Ø¬ ÙˆØªØ´ÙˆÙŠØ´">Ø¥Ø²Ø¹Ø§Ø¬ ÙˆØªØ´ÙˆÙŠØ´</option>
                                    <option value="Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª">Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</option>
                                    <option value="Ø´Ø¬Ø§Ø± Ø£Ùˆ Ø¹Ù†Ù">Ø´Ø¬Ø§Ø± Ø£Ùˆ Ø¹Ù†Ù</option>
                                    <option value="ØªØ¯Ø®ÙŠÙ† Ø£Ùˆ ØªØ¹Ø§Ø·ÙŠ">ØªØ¯Ø®ÙŠÙ† Ø£Ùˆ ØªØ¹Ø§Ø·ÙŠ</option>
                                    <option value="Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±">Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±</option>
                                    <option value="Ø¹Ø¯Ù… Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†">Ø¹Ø¯Ù… Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>ØµÙŠØºØ© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± (ÙŠØªÙ… ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù) *</label>
                                <textarea id="warningContent" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±..." required></textarea>
                                <small style="color: var(--gray); margin-top: 5px; display: block;">Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</small>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" id="sendWhatsApp" checked style="width: auto; margin: 0;">
                                    <span>ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</span>
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-warning"><i class="fas fa-exclamation-triangle"></i> Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</button>
                                <button type="reset" class="btn btn-outline"><i class="fas fa-redo"></i> Ù…Ø³Ø­</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h3>
                            <div class="table-controls">
                                <select id="warningFilterType" onchange="filterWarnings()">
                                    <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ --</option>
                                    <option value="1">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø£ÙˆÙ„</option>
                                    <option value="2">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                    <option value="3">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                </select>
                                <select id="warningFilterStatus" onchange="filterWarnings()">
                                    <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª --</option>
                                    <option value="active">Ù†Ø´Ø·</option>
                                    <option value="archived">Ù…Ø¤Ø±Ø´Ù</option>
                                </select>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="warningsTable">
                                    <tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
                <div class="page" id="reports">
                    <div class="page-title">
                        <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
                        </div>
                        
                        <form id="reportForm" onsubmit="generateReport(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± *</label>
                                    <select id="reportType" required onchange="updateReportForm()">
                                        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± --</option>
                                        <option value="student">ØªÙ‚Ø±ÙŠØ± Ø¹Ù† Ø·Ø§Ù„Ø¨ Ù…Ø¹ÙŠÙ†</option>
                                        <option value="period">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</option>
                                        <option value="summary">Ù…Ù„Ø®Øµ Ø¹Ø§Ù…</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="studentSelectGroup" style="display: none;">
                                    <label>Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                                    <select id="reportStudent">
                                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ --</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;">
                                    <input type="date" id="reportStartDate" required>
                                    <span style="text-align: center; color: var(--gray);">Ø¥Ù„Ù‰</span>
                                    <input type="date" id="reportEndDate" required>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-file-pdf"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                                <button type="button" class="btn btn-secondary" onclick="printReport()" id="printBtn" style="display: none;"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                                <button type="button" class="btn btn-warning" onclick="exportReportToExcel()" id="exportReportBtn" style="display: none;"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="reportContainer" style="display: none;" class="card">
                        <div id="reportContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button type="button" class="close-modal" onclick="closeAddStudentModal()">Ã—</button>
            </div>
            <form id="addStudentForm" onsubmit="addStudent(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³ *</label>
                        <input type="text" id="studentId" placeholder="Ù…Ø«Ø§Ù„: 12345" required>
                        <small style="color: var(--gray);" id="idCheckMsg"></small>
                    </div>
                    
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ *</label>
                        <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„ØµÙ *</label>
                        <select id="studentGrade" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                            <option value="KG1">KG1</option>
                            <option value="KG2">KG2</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                            <option value="Grade 10">Grade 10</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="Grade 12">Grade 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ø§Ù„Ø´Ø¹Ø¨Ø© *</label>
                        <select id="studentSection" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
                    <input type="text" id="studentZone" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙƒÙ†ÙŠØ©" required>
                </div>
                
                <div class="form-group">
                    <label>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ù…Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙˆÙ„Ø©) *</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-weight: 600; color: var(--primary); background: #f1f5f9; padding: 10px 12px; border-radius: 6px; white-space: nowrap;">+971</span>
                        <input type="tel" id="parentPhone" placeholder="5xxxxxxxx (Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙØ±)" maxlength="9" required>
                    </div>
                    <small style="color: var(--gray); margin-top: 5px; display: block;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙØ± Ø£Ùˆ +971</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    <button type="button" class="btn btn-outline" onclick="closeAddStudentModal()"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-excel"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ø§Ø­ØªØ±Ø§ÙÙŠ</h3>
                <button type="button" class="close-modal" onclick="closeImportModal()">Ã—</button>
            </div>
            <form id="importForm" onsubmit="importExcel(event)">
                <div class="form-group">
                    <label>Ø§Ø®ØªØ± Ù…Ù„Ù Ø¥ÙƒØ³Ù„ *</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="previewImportFile(event)">
                        <label class="file-input-label" id="fileInputLabel" for="excelFile">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                            <div><strong>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</strong></div>
                            <small style="color: var(--gray); margin-top: 8px; display: block;">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: xlsx, xls, csv</small>
                        </label>
                    </div>
                    <small style="color: var(--gray); margin-top: 8px; display: block;" id="fileNameDisplay"></small>
                </div>

                <div id="importPreviewSection" style="display: none;">
                    <div class="import-stats">
                        <div class="import-stat success">
                            <div>âœ… ØµØ­ÙŠØ­</div>
                            <strong id="validCount">0</strong>
                            <small>Ø³Ø¬Ù„</small>
                        </div>
                        <div class="import-stat warning">
                            <div>âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª</div>
                            <strong id="warningCount">0</strong>
                            <small>Ø³Ø¬Ù„</small>
                        </div>
                        <div class="import-stat error">
                            <div>âŒ Ø£Ø®Ø·Ø§Ø¡</div>
                            <strong id="errorCount">0</strong>
                            <small>Ø³Ø¬Ù„</small>
                        </div>
                    </div>

                    <div class="import-preview" id="importPreview"></div>
                </div>
                
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin: 20px 0; display: none;" id="templateInfo">
                    <p style="font-weight: 600; margin-bottom: 12px; color: var(--primary);">ğŸ“‹ ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</p>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--gray);">
                        ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:<br>
                        <strong>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³ | Ø§Ù„Ø§Ø³Ù… | Ø§Ù„ØµÙ | Ø§Ù„Ø´Ø¹Ø¨Ø© | Ø§Ù„Ù…Ù†Ø·Ù‚Ø© | Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯</strong>
                    </p>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-secondary" id="importBtn" disabled><i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                    <button type="button" class="btn btn-outline" onclick="closeImportModal()"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div class="modal" id="studentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="studentDetailTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <button type="button" class="close-modal" onclick="closeStudentDetailModal()">Ã—</button>
            </div>
            <div id="studentDetailContent"></div>
        </div>
    </div>

    <script>
        // ========== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ==========
        let db = null;
        let currentUser = null;
        let students = [];
        let warnings = [];
        let filteredWarningsForReport = [];
        let importData = [];
        let isImporting = false;
        
        // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDE4dDRBvnwrOslrWfozq-PggV5ZsIFHxY",
            authDomain: "students-problems-c5675.firebaseapp.com",
            databaseURL: "https://students-problems-c5675-default-rtdb.firebaseio.com",
            projectId: "students-problems-c5675",
            storageBucket: "students-problems-c5675.firebasestorage.app",
            messagingSenderId: "177863466793",
            appId: "1:177863466793:web:8f7bab519baec060e56138"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('âœ… Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
        }
        
        // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ==========
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setupFileUpload();
            if (db) {
                loadFirebaseData();
            }
            setTodayDate();
        });
        
        function setupEventListeners() {
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.dataset.page);
                });
            });
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('excelFile');
            const fileInputLabel = document.getElementById('fileInputLabel');

            // Drag and drop
            fileInputLabel.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileInputLabel.classList.add('active');
            });

            fileInputLabel.addEventListener('dragleave', () => {
                fileInputLabel.classList.remove('active');
            });

            fileInputLabel.addEventListener('drop', (e) => {
                e.preventDefault();
                fileInputLabel.classList.remove('active');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    previewImportFile({ target: { files: files } });
                }
            });

            fileInput.addEventListener('change', previewImportFile);
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
        }
        
        // ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ==========
        function loadFirebaseData() {
            loadStudentsFromFirebase();
            loadWarningsFromFirebase();
        }
        
        function loadStudentsFromFirebase() {
            db.ref('students').on('value', snapshot => {
                students = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        students.push({
                            ...data[key],
                            firebaseId: key
                        });
                    });
                }
                loadStudents();
                updateStudentSelects();
            });
        }
        
        function loadWarningsFromFirebase() {
            db.ref('warnings').on('value', snapshot => {
                warnings = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        warnings.push({
                            ...data[key],
                            firebaseId: key
                        });
                    });
                }
                loadWarnings();
                loadDashboardStats();
            });
        }
        
        // ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ==========
        function loadInitialData() {
            loadDashboardStats();
            loadStudents();
            loadWarnings();
            updateStudentSelects();
        }
        
        function loadDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayWarningsCount = warnings.filter(w => w.date === today && w.status === 'active').length;
            const thirdWarningsCount = warnings.filter(w => w.type === '3' && w.status === 'active').length;
            const archivedCount = warnings.filter(w => w.status === 'archived').length;
            
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('todayWarnings').textContent = todayWarningsCount;
            document.getElementById('thirdWarnings').textContent = thirdWarningsCount;
            document.getElementById('archivedWarnings').textContent = archivedCount;
            
            const recentWarnings = warnings.filter(w => w.status === 'active').sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const recentTable = document.getElementById('recentWarningsTable');
            recentTable.innerHTML = '';
            
            if (recentWarnings.length === 0) {
                recentTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
            } else {
                recentWarnings.forEach(w => {
                    const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${w.studentName}</strong></td>
                        <td>${w.violation}</td>
                        <td><span class="badge badge-${w.type === '3' ? 'danger' : w.type === '2' ? 'warning' : 'primary'}">${typeText}</span></td>
                        <td>${formatDate(w.date)}</td>
                        <td><span class="status regular">Ù†Ø´Ø·</span></td>
                    `;
                    recentTable.appendChild(row);
                });
            }
            
            if (thirdWarningsCount > 0) {
                const alertDiv = document.getElementById('dashboardAlert');
                alertDiv.innerHTML = `<div class="alert danger"><i class="fas fa-exclamation-circle"></i><div>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: Ù‡Ù†Ø§Ùƒ <strong>${thirdWarningsCount}</strong> Ø·Ø§Ù„Ø¨ ÙˆØµÙ„ Ù„Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø« ÙˆÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© ÙÙˆØ±ÙŠØ©!</div></div>`;
            }
        }
        
        function loadStudents() {
            const table = document.getElementById('studentsTable');
            const count = document.getElementById('studentCount');
            count.textContent = students.length;
            table.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                const warningCount = warnings.filter(w => w.studentId === student.id && w.status === 'active').length;
                const warningBadge = warningCount > 0 ? `<span class="badge badge-${warningCount === 3 ? 'danger' : warningCount === 2 ? 'warning' : 'primary'}">${warningCount}</span>` : '-';
                
                row.innerHTML = `
                    <td><strong>${student.id}</strong></td>
                    <td>${student.name}</td>
                    <td>${student.grade}</td>
                    <td>${student.section}</td>
                    <td>${student.zone}</td>
                    <td dir="ltr">+971${student.phone.substring(1)}</td>
                    <td>${warningBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="viewStudentDetails('${student.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="showPage('warnings'); document.getElementById('warningStudent').value = '${student.id}';" title="Ø¥ØµØ¯Ø§Ø± Ø¥Ù†Ø°Ø§Ø±"><i class="fas fa-exclamation-triangle"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                table.appendChild(row);
            });
            
            updateStudentSelects();
        }
        
        function loadWarnings() {
            const table = document.getElementById('warningsTable');
            table.innerHTML = '';
            
            const activeWarnings = warnings.filter(w => w.status === 'active');
            
            if (activeWarnings.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©</td></tr>';
            } else {
                activeWarnings.forEach(w => {
                    const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${w.studentName}</strong></td>
                        <td><span class="badge badge-${w.type === '3' ? 'danger' : w.type === '2' ? 'warning' : 'primary'}">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}</span></td>
                        <td>${w.violation}</td>
                        <td>${formatDate(w.date)}</td>
                        <td><span class="status regular">Ù†Ø´Ø·</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" onclick="viewWarningDetails('${w.id}')"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-secondary" onclick="archiveWarning('${w.id}')" title="Ø£Ø±Ø´ÙØ©"><i class="fas fa-archive"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWarning('${w.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    table.appendChild(row);
                });
            }
        }
        
        function updateStudentSelects() {
            const select = document.getElementById('warningStudent');
            const reportSelect = document.getElementById('reportStudent');
            
            [select, reportSelect].forEach(s => {
                if (s) {
                    const currentValue = s.value;
                    s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ --</option>';
                    students.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.id}) - ${student.grade}`;
                        s.appendChild(option);
                    });
                    s.value = currentValue;
                }
            });
        }
        
        // ========== ÙˆØ¸Ø§Ø¦Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
        function login(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'transportation' && password === '606486') {
                currentUser = { id: 1, name: 'Ù…Ù†Ø³Ù‚ Ø§Ù„Ù†Ù‚Ù„' };
                showApp();
                showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } else {
                showToast('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!', 'error');
            }
        }
        
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
        }
        
        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                currentUser = null;
                showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            }
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) link.classList.add('active');
            });
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId)?.classList.add('active');
            
            if (pageId === 'students') {
                loadStudents();
            } else if (pageId === 'warnings') {
                loadWarnings();
                setTodayDate();
            }
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ==========
        function showAddStudentModal() {
            document.getElementById('addStudentForm').reset();
            document.getElementById('idCheckMsg').textContent = '';
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function closeAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('active');
        }
        
        function addStudent(e) {
            e.preventDefault();
            
            const id = document.getElementById('studentId').value.trim();
            
            if (students.some(s => s.id === id)) {
                showToast('âŒ Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!', 'error');
                return;
            }
            
            const newStudent = {
                id: id,
                name: document.getElementById('studentName').value,
                grade: document.getElementById('studentGrade').value,
                section: document.getElementById('studentSection').value,
                zone: document.getElementById('studentZone').value,
                phone: '0' + document.getElementById('parentPhone').value
            };
            
            students.push(newStudent);
            
            if (db) {
                db.ref('students/' + id).set(newStudent).catch(error => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                });
            }
            
            loadStudents();
            closeAddStudentModal();
            showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }
        
        function showImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importPreviewSection').style.display = 'none';
            document.getElementById('fileNameDisplay').textContent = '';
            document.getElementById('importBtn').disabled = true;
            importData = [];
            document.getElementById('importModal').classList.add('active');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            importData = [];
            document.getElementById('excelFile').value = '';
        }

        function normalizeValue(value, type) {
            if (!value) return null;
            value = value.toString().trim();

            switch(type) {
                case 'id':
                    return value.replace(/\D/g, '');
                case 'name':
                    return value.replace(/[0-9]/g, '').trim();
                case 'section':
                    const sectionNum = value.replace(/\D/g, '');
                    return sectionNum ? sectionNum : value;
                case 'phone':
                    let phone = value.replace(/\D/g, '');
                    if (phone.startsWith('00971')) {
                        phone = phone.replace(/^00971/, '0');
                    } else if (phone.startsWith('971')) {
                        phone = '0' + phone.replace(/^971/, '');
                    } else if (!phone.startsWith('0') && phone.length === 9) {
                        phone = '0' + phone;
                    }
                    return phone;
                default:
                    return value;
            }
        }

        function validateStudent(row) {
            const errors = [];
            const warnings = [];

            if (!row.id || !normalizeValue(row.id, 'id')) {
                errors.push('Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
            }
            if (!row.name || !normalizeValue(row.name, 'name')) {
                errors.push('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙØ§Ø±Øº');
            }
            if (!row.grade || row.grade.toString().trim() === '') {
                errors.push('Ø§Ù„ØµÙ ÙØ§Ø±Øº');
            }
            if (!row.section || !normalizeValue(row.section, 'section')) {
                errors.push('Ø§Ù„Ø´Ø¹Ø¨Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
            if (!row.zone || row.zone.toString().trim() === '') {
                errors.push('Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙØ§Ø±ØºØ©');
            }
            if (!row.phone || !normalizeValue(row.phone, 'phone')) {
                errors.push('Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
            }

            if (students.some(s => s.id === normalizeValue(row.id, 'id'))) {
                warnings.push('Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
            }

            return { errors, warnings, isValid: errors.length === 0 };
        }

        function previewImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        showToast('âŒ Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙˆØ±Ø§Ù‚ Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
                        return;
                    }

                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    if (!sheet) {
                        showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
                        return;
                    }

                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    if (rows.length < 2) {
                        showToast('âŒ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
                        return;
                    }

                    importData = [];
                    let validCount = 0, warningCount = 0, errorCount = 0;
                    let previewHTML = '<table class="preview-table"><thead><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th></tr></thead><tbody>';

                    for (let i = 1; i < Math.min(rows.length, 101); i++) {
                        const row = rows[i];
                        if (!row[0]) continue;

                        const student = {
                            id: normalizeValue(row[0], 'id'),
                            name: normalizeValue(row[1], 'name'),
                            grade: row[2] ? row[2].toString().trim() : '',
                            section: normalizeValue(row[3], 'section'),
                            zone: row[4] ? row[4].toString().trim() : '',
                            phone: normalizeValue(row[5], 'phone')
                        };

                        const validation = validateStudent(student);

                        let statusIcon = 'âœ…';
                        let statusClass = 'success';

                        if (validation.errors.length > 0) {
                            statusIcon = 'âŒ';
                            statusClass = 'error';
                            errorCount++;
                            previewHTML += `<tr style="background: #fef2f2;"><td>${statusIcon}</td><td style="color: var(--danger); font-size: 0.85rem;">${validation.errors.join(', ')}</td><td>${student.id || 'N/A'}</td><td>${student.name || 'N/A'}</td><td>${student.grade || 'N/A'}</td><td>${student.section || 'N/A'}</td></tr>`;
                        } else if (validation.warnings.length > 0) {
                            statusIcon = 'âš ï¸';
                            statusClass = 'warning';
                            warningCount++;
                            previewHTML += `<tr style="background: #fffbeb;"><td>${statusIcon}</td><td style="color: var(--warning); font-size: 0.85rem;">${validation.warnings.join(', ')}</td><td>${student.id}</td><td>${student.name}</td><td>${student.grade}</td><td>${student.section}</td></tr>`;
                        } else {
                            validCount++;
                            previewHTML += `<tr style="background: #ecfdf5;"><td>${statusIcon}</td><td style="color: var(--secondary); font-size: 0.85rem;">ØµØ­ÙŠØ­</td><td>${student.id}</td><td>${student.name}</td><td>${student.grade}</td><td>${student.section}</td></tr>`;
                        }

                        if (validation.isValid) {
                            importData.push(student);
                        }
                    }

                    previewHTML += '</tbody></table>';

                    document.getElementById('validCount').textContent = validCount;
                    document.getElementById('warningCount').textContent = warningCount;
                    document.getElementById('errorCount').textContent = errorCount;
                    document.getElementById('importPreview').innerHTML = previewHTML;
                    document.getElementById('importPreviewSection').style.display = 'block';
                    document.getElementById('importBtn').disabled = importData.length === 0;

                    if (importData.length > 0) {
                        showToast(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${importData.length} Ø·Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯`, 'success');
                    } else if (errorCount > 0) {
                        showToast(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯! (${errorCount} Ø£Ø®Ø·Ø§Ø¡)`, 'warning');
                    } else {
                        showToast('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù!', 'error');
                    }

                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:', error);
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠØ­Ø©!', 'error');
                }
            };

            reader.onerror = function() {
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!', 'error');
            };

            reader.readAsArrayBuffer(file);
        }

        function importExcel(e) {
            e.preventDefault();

            if (importData.length === 0) {
                showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!', 'error');
                return;
            }

            isImporting = true;
            const btn = document.getElementById('importBtn');
            const btnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...';

            let importedCount = 0;
            const failedIds = [];

            importData.forEach(student => {
                students.push(student);

                if (db) {
                    db.ref('students/' + student.id).set(student).catch(error => {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                        failedIds.push(student.id);
                    });
                }

                importedCount++;
            });

            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ± Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            setTimeout(() => {
                loadStudents();
                closeImportModal();

                let message = `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!`;
                if (failedIds.length > 0) {
                    message += ` (ØªØ­Ø°ÙŠØ±: ${failedIds.length} Ø·Ø§Ù„Ø¨ Ù‚Ø¯ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸Ù‡Ù… Ø¨Ù†Ø¬Ø§Ø­)`;
                }
                showToast(message, 'success');

                isImporting = false;
                btn.disabled = false;
                btn.innerHTML = btnText;
            }, 1500);
        }

        function downloadTemplate() {
            try {
                const templateData = [
                    {
                        'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³': '12345',
                        'Ø§Ù„Ø§Ø³Ù…': 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
                        'Ø§Ù„ØµÙ': 'Grade 5',
                        'Ø§Ù„Ø´Ø¹Ø¨Ø©': '1',
                        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': 'Ø§Ù„Ù…Ø±Ø¬Ø§Ù†',
                        'Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯': '0501234567'
                    },
                    {
                        'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³': '12346',
                        'Ø§Ù„Ø§Ø³Ù…': 'ÙØ§Ø·Ù…Ø© Ø­Ø³Ù† Ù…Ø­Ù…ÙˆØ¯',
                        'Ø§Ù„ØµÙ': 'Grade 4',
                        'Ø§Ù„Ø´Ø¹Ø¨Ø©': '2',
                        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': 'Ø§Ù„Ù…Ù†Ø§Ø±Ø©',
                        'Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯': '0561234567'
                    },
                    {
                        'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³': '12347',
                        'Ø§Ù„Ø§Ø³Ù…': 'Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡',
                        'Ø§Ù„ØµÙ': 'Grade 6',
                        'Ø§Ù„Ø´Ø¹Ø¨Ø©': '3',
                        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': 'Ø§Ù„ÙƒØ±Ø§Ù…Ø©',
                        'Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯': '0551234567'
                    }
                ];

                const worksheet = XLSX.utils.json_to_sheet(templateData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„Ø·Ù„Ø§Ø¨');

                worksheet['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 15 },
                    { wch: 15 }
                ];

                // ØªØ¹ÙŠÙŠÙ† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ© Ù„Ù„Ø±Ø£Ø³
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "1e40af" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };

                Object.keys(worksheet).forEach(cell => {
                    if (cell.startsWith('A1') || cell.startsWith('B1') || cell.startsWith('C1') || cell.startsWith('D1') || cell.startsWith('E1') || cell.startsWith('F1')) {
                        if (!worksheet[cell].s) worksheet[cell].s = {};
                        worksheet[cell].s = headerStyle;
                    }
                });

                const fileName = 'Ù†Ù…ÙˆØ°Ø¬_Ø§Ø³ØªÙŠØ±Ø§Ø¯_Ø§Ù„Ø·Ù„Ø§Ø¨_' + new Date().toISOString().split('T')[0] + '.xlsx';
                XLSX.writeFile(workbook, fileName);
                showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬!', 'error');
            }
        }
        
        function exportStudentsToExcel() {
            try {
                if (students.length === 0) {
                    showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØµØ¯ÙŠØ±!', 'warning');
                    return;
                }

                const data = students.map(s => ({
                    'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³': s.id,
                    'Ø§Ù„Ø§Ø³Ù…': s.name,
                    'Ø§Ù„ØµÙ': s.grade,
                    'Ø§Ù„Ø´Ø¹Ø¨Ø©': s.section,
                    'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': s.zone,
                    'Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯': '0' + s.phone.substring(1)
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
                
                worksheet['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 15 },
                    { wch: 15 }
                ];

                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
                for (let i = 65; i <= 70; i++) { // A-F
                    const cell = String.fromCharCode(i) + '1';
                    if (worksheet[cell]) {
                        if (!worksheet[cell].s) worksheet[cell].s = {};
                        worksheet[cell].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "1e40af" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                }
                
                const fileName = 'Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨_' + new Date().toISOString().split('T')[0] + '.xlsx';
                XLSX.writeFile(workbook, fileName);
                showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
            }
        }
        
        function deleteStudent(id) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                students = students.filter(s => s.id !== id);
                warnings = warnings.filter(w => w.studentId !== id);
                
                if (db) {
                    db.ref('students/' + id).remove();
                    warnings.forEach(w => {
                        if (w.studentId === id) {
                            db.ref('warnings/' + w.id).remove();
                        }
                    });
                }
                
                loadStudents();
                loadWarnings();
                loadDashboardStats();
                showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            }
        }
        
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const classFilter = document.getElementById('studentClassFilter').value;
            const rows = document.querySelectorAll('#studentsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const classCell = row.cells[2]?.textContent || '';
                const matchesSearch = text.includes(searchTerm);
                const matchesClass = !classFilter || classCell.includes(classFilter);
                row.style.display = (matchesSearch && matchesClass) ? '' : 'none';
            });
        }
        
        function viewStudentDetails(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            const studentWarnings = warnings.filter(w => w.studentId === id);
            let warningsHtml = '<p style="text-align: center; color: var(--gray);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p>';
            
            if (studentWarnings.length > 0) {
                warningsHtml = '<table style="width: 100%; margin-top: 15px; border-collapse: collapse;">';
                warningsHtml += '<tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;"><th style="padding: 10px; text-align: right;">Ø§Ù„Ù†ÙˆØ¹</th><th style="padding: 10px; text-align: right;">Ø§Ù„Ø³Ø¨Ø¨</th><th style="padding: 10px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="padding: 10px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>';
                
                studentWarnings.forEach(w => {
                    const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type];
                    const statusText = w.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø¤Ø±Ø´Ù';
                    warningsHtml += `<tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 10px;">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}</td><td style="padding: 10px;">${w.violation}</td><td style="padding: 10px;">${formatDate(w.date)}</td><td style="padding: 10px;"><span class="status ${w.status === 'active' ? 'regular' : 'archived'}">${statusText}</span></td></tr>`;
                });
                
                warningsHtml += '</table>';
            }
            
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³</p>
                        <p style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${student.id}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                        <p style="font-size: 1.1rem; font-weight: 700;">${student.name}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø©</p>
                        <p style="font-size: 1.1rem;">${student.grade} / ${student.section}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>
                        <p style="font-size: 1.1rem;">${student.zone}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯</p>
                        <p style="font-size: 1.1rem; direction: ltr;">+971${student.phone.substring(1)}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p>
                        <p style="font-size: 1.3rem; font-weight: 700; color: ${studentWarnings.length > 2 ? 'var(--danger)' : studentWarnings.length > 0 ? 'var(--warning)' : 'var(--secondary)'};">${studentWarnings.length}</p>
                    </div>
                </div>
                
                <div style="border-top: 2px solid #e2e8f0; padding-top: 20px;">
                    <h4 style="color: var(--primary); font-weight: 700; margin-bottom: 15px;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h4>
                    ${warningsHtml}
                </div>
            `;
            
            document.getElementById('studentDetailTitle').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ - ${student.name}`;
            document.getElementById('studentDetailContent').innerHTML = content;
            document.getElementById('studentDetailModal').classList.add('active');
        }
        
        function closeStudentDetailModal() {
            document.getElementById('studentDetailModal').classList.remove('active');
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª ==========
        function issueWarning(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('warningStudent').value;
            const warningType = document.getElementById('warningType').value;
            const violationType = document.getElementById('violationType').value;
            const warningContent = document.getElementById('warningContent').value;
            const sendWhatsApp = document.getElementById('sendWhatsApp').checked;
            
            if (!studentId || !warningType || !violationType || !warningContent) {
                showToast('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!', 'error');
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const previousWarnings = warnings.filter(w => w.studentId === studentId && w.status === 'active');
            
            if (previousWarnings.length > 0) {
                const lastWarning = previousWarnings[previousWarnings.length - 1];
                if (lastWarning.type === '3') {
                    showToast('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØµÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«!', 'error');
                    return;
                }
            }
            
            const newWarning = {
                id: 'W' + Date.now(),
                studentId: studentId,
                studentName: student.name,
                type: warningType,
                violation: violationType,
                content: warningContent,
                date: new Date().toISOString().split('T')[0],
                status: 'active',
                phone: student.phone
            };
            
            warnings.push(newWarning);
            
            if (db) {
                db.ref('warnings/' + newWarning.id).set(newWarning).catch(error => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±:', error);
                });
            }
            
            if (sendWhatsApp) {
                sendWarningViaWhatsApp(student, warningType, warningContent);
            }
            
            loadStudents();
            loadWarnings();
            loadDashboardStats();
            document.getElementById('warningForm').reset();
            showToast('âœ… ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }
        
        function sendWarningViaWhatsApp(student, warningType, content) {
            const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[warningType];
            const phoneNumber = '971' + student.phone.substring(1);
            
            const message = `ğŸ“¢ *ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø«Ø±ÙˆØ§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©*\n\n` +
                `ØªÙ… Ø¥ØµØ¯Ø§Ø± *Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}* Ù„Ù„Ø·Ø§Ù„Ø¨/Ø©:\n*${student.name}*\n\n` +
                `_Ø§Ù„ØµÙ:_ ${student.grade} / ${student.section}\n\n` +
                `_ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±:_\n${content}\n\n` +
                `ğŸšŒ *Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ*`;
            
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function filterWarnings() {
            const typeFilter = document.getElementById('warningFilterType').value;
            const statusFilter = document.getElementById('warningFilterStatus').value;
            const rows = document.querySelectorAll('#warningsTable tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return;
                
                const typeCell = row.cells[1]?.textContent || '';
                const statusCell = row.cells[4]?.textContent || '';
                
                const matchesType = !typeFilter || typeCell.includes(typeFilter === '1' ? 'Ø§Ù„Ø£ÙˆÙ„' : typeFilter === '2' ? 'Ø§Ù„Ø«Ø§Ù†ÙŠ' : 'Ø§Ù„Ø«Ø§Ù„Ø«');
                const matchesStatus = !statusFilter || statusCell.toLowerCase().includes(statusFilter);
                
                row.style.display = (matchesType && matchesStatus) ? '' : 'none';
            });
        }
        
        function viewWarningDetails(id) {
            const warning = warnings.find(w => w.id === id);
            if (!warning) return;
            
            const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[warning.type];
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                        <p style="font-size: 1.1rem; font-weight: 700;">${warning.studentName}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</p>
                        <p><span class="badge badge-${warning.type === '3' ? 'danger' : warning.type === '2' ? 'warning' : 'primary'}">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}</span></p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ù„Ø³Ø¨Ø¨</p>
                        <p style="font-size: 1.1rem;">${warning.violation}</p>
                    </div>
                    <div>
                        <p style="color: var(--gray); font-weight: 600; margin-bottom: 5px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
                        <p style="font-size: 1.1rem;">${formatDate(warning.date)}</p>
                    </div>
                </div>
                
                <div style="border-top: 2px solid #e2e8f0; padding-top: 20px;">
                    <h4 style="color: var(--primary); font-weight: 700; margin-bottom: 15px;">ğŸ“ Ù†Øµ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</h4>
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-right: 4px solid var(--primary); line-height: 1.8;">
                        ${warning.content}
                    </div>
                </div>
            `;
            
            document.getElementById('studentDetailTitle').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± - ${warning.studentName}`;
            document.getElementById('studentDetailContent').innerHTML = content;
            document.getElementById('studentDetailModal').classList.add('active');
        }
        
        function archiveWarning(id) {
            const warning = warnings.find(w => w.id === id);
            if (warning) {
                warning.status = 'archived';
                
                if (db) {
                    db.ref('warnings/' + id).update({ status: 'archived' });
                }
                
                loadWarnings();
                loadDashboardStats();
                showToast('ğŸ“ ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            }
        }
        
        function deleteWarning(id) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±ØŸ')) {
                warnings = warnings.filter(w => w.id !== id);
                
                if (db) {
                    db.ref('warnings/' + id).remove();
                }
                
                loadWarnings();
                loadStudents();
                loadDashboardStats();
                showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            }
        }
        
        // ========== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ==========
        function updateReportForm() {
            const reportType = document.getElementById('reportType').value;
            document.getElementById('studentSelectGroup').style.display = reportType === 'student' ? 'block' : 'none';
        }
        
        function generateReport(e) {
            e.preventDefault();
            
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!reportType || !startDate || !endDate) {
                showToast('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!', 'error');
                return;
            }
            
            filteredWarningsForReport = warnings.filter(w => w.date >= startDate && w.date <= endDate);
            let reportHTML = generateReportHTML(reportType, startDate, endDate);
            
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportContainer').style.display = 'block';
            document.getElementById('printBtn').style.display = 'inline-flex';
            document.getElementById('exportReportBtn').style.display = 'inline-flex';
            
            showToast('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }
        
        function generateReportHTML(type, startDate, endDate) {
            const filteredWarnings = warnings.filter(w => w.date >= startDate && w.date <= endDate && w.status === 'active');
            const schoolName = 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø«Ø±ÙˆØ§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©';
            const reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ';
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid var(--primary); padding-bottom: 20px;">
                    <h1 style="color: var(--primary); font-size: 2rem; margin-bottom: 10px;">${reportTitle}</h1>
                    <p style="font-size: 1.2rem; color: var(--gray); margin-bottom: 5px;">${schoolName}</p>
                    <p style="color: var(--gray);">Ø§Ù„ÙØªØ±Ø© Ù…Ù†: ${formatDate(startDate)} Ø¥Ù„Ù‰ ${formatDate(endDate)}</p>
                    <p style="color: var(--gray); font-size: 0.9rem; margin-top: 10px;">ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ÙÙŠ: ${new Date().toLocaleString('ar-SA')}</p>
                </div>
            `;
            
            if (type === 'student') {
                const studentId = document.getElementById('reportStudent').value;
                const student = students.find(s => s.id === studentId);
                
                if (student) {
                    const studentWarnings = filteredWarnings.filter(w => w.studentId === studentId);
                    
                    html += `
                        <div style="margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©</h3>
                            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student.name}</p>
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³:</strong> ${student.id}</p>
                            <p><strong>Ø§Ù„ØµÙ:</strong> ${student.grade} / ${student.section}</p>
                            <p><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${student.zone}</p>
                            <p><strong>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</strong> +971${student.phone.substring(1)}</p>
                        </div>
                    `;
                    
                    if (studentWarnings.length > 0) {
                        html += `<h3 style="color: var(--primary); margin-bottom: 15px;">Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª (${studentWarnings.length})</h3>`;
                        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
                        html += '<tr style="background: var(--primary); color: white;"><th style="padding: 12px; text-align: right;">Ø§Ù„Ù†ÙˆØ¹</th><th style="padding: 12px; text-align: right;">Ø§Ù„Ø³Ø¨Ø¨</th><th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>';
                        
                        studentWarnings.forEach((w, idx) => {
                            const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type];
                            const statusText = w.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø¤Ø±Ø´Ù';
                            html += `<tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'}; border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px;">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}</td><td style="padding: 12px;">${w.violation}</td><td style="padding: 12px;">${formatDate(w.date)}</td><td style="padding: 12px;">${statusText}</td></tr>`;
                        });
                        
                        html += '</table>';
                    } else {
                        html += '<p style="color: var(--gray); text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>';
                    }
                }
            } else if (type === 'period') {
                const typeGroups = {};
                filteredWarnings.forEach(w => {
                    if (!typeGroups[w.type]) typeGroups[w.type] = [];
                    typeGroups[w.type].push(w);
                });
                
                html += `<h3 style="color: var(--primary); margin-bottom: 20px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ù†ÙˆØ¹</h3>`;
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">';
                
                const types = [
                    { key: '1', label: 'Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰', color: 'var(--primary)' },
                    { key: '2', label: 'Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©', color: 'var(--warning)' },
                    { key: '3', label: 'Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ù„Ø«Ø©', color: 'var(--danger)' }
                ];
                
                types.forEach(t => {
                    const count = typeGroups[t.key]?.length || 0;
                    html += `
                        <div style="background: ${t.color}; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 2.5rem; font-weight: 800; margin: 0;">${count}</p>
                            <p style="margin-top: 10px;">${t.label}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                html += '<h3 style="color: var(--primary); margin-bottom: 15px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</h3>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: var(--primary); color: white;"><th style="padding: 12px; text-align: right;">Ø§Ù„Ø·Ø§Ù„Ø¨</th><th style="padding: 12px; text-align: right;">Ø§Ù„Ù†ÙˆØ¹</th><th style="padding: 12px; text-align: right;">Ø§Ù„Ø³Ø¨Ø¨</th><th style="padding: 12px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>';
                
                filteredWarnings.forEach((w, idx) => {
                    const typeText = { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type];
                    html += `<tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'}; border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px;">${w.studentName}</td><td style="padding: 12px;">Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ${typeText}</td><td style="padding: 12px;">${w.violation}</td><td style="padding: 12px;">${formatDate(w.date)}</td></tr>`;
                });
                
                html += '</table>';
            } else if (type === 'summary') {
                const totalStudents = new Set(filteredWarnings.map(w => w.studentId)).size;
                const firstWarnings = filteredWarnings.filter(w => w.type === '1').length;
                const secondWarnings = filteredWarnings.filter(w => w.type === '2').length;
                const thirdWarnings = filteredWarnings.filter(w => w.type === '3').length;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 2.5rem; font-weight: 800; margin: 0;">${totalStudents}</p>
                            <p style="margin-top: 10px;">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù†Ø°Ø±ÙŠÙ†</p>
                        </div>
                        <div style="background: var(--secondary); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <p style="font-size: 2.5rem; font-weight: 800; margin: 0;">${filteredWarnings.length}</p>
                            <p style="margin-top: 10px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p>
                        </div>
                    </div>
                    
                    <h3 style="color: var(--primary); margin-bottom: 15px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #f8fafc;"><td style="padding: 12px; border-bottom: 2px solid #e2e8f0;"><strong>Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰:</strong></td><td style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left;">${firstWarnings}</td></tr>
                        <tr style="background: white;"><td style="padding: 12px; border-bottom: 2px solid #e2e8f0;"><strong>Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©:</strong></td><td style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left;">${secondWarnings}</td></tr>
                        <tr style="background: #f8fafc;"><td style="padding: 12px;"><strong>Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ù„Ø«Ø©:</strong></td><td style="padding: 12px; text-align: left;">${thirdWarnings}</td></tr>
                    </table>
                `;
            }
            
            html += '<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: var(--gray); font-size: 0.9rem;">Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø§Øµ</div>';
            
            return html;
        }
        
        function printReport() {
            window.print();
        }
        
        function exportReportToExcel() {
            try {
                const reportType = document.getElementById('reportType').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filteredWarnings = warnings.filter(w => w.date >= startDate && w.date <= endDate && w.status === 'active');
                
                if (filteredWarnings.length === 0) {
                    showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±!', 'warning');
                    return;
                }

                const data = filteredWarnings.map(w => ({
                    'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': w.studentName,
                    'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ÙŠØ³': w.studentId,
                    'Ù†ÙˆØ¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±': { '1': 'Ø§Ù„Ø£ÙˆÙ„', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«' }[w.type],
                    'Ø§Ù„Ø³Ø¨Ø¨': w.violation,
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': formatDate(w.date),
                    'Ø§Ù„Ø­Ø§Ù„Ø©': w.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø¤Ø±Ø´Ù'
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                
                worksheet['!cols'] = [
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 10 }
                ];

                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
                for (let i = 65; i <= 70; i++) { // A-F
                    const cell = String.fromCharCode(i) + '1';
                    if (worksheet[cell]) {
                        if (!worksheet[cell].s) worksheet[cell].s = {};
                        worksheet[cell].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "1e40af" } }
                        };
                    }
                }
                
                const fileName = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª_' + startDate + '.xlsx';
                XLSX.writeFile(workbook, fileName);
                showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±!', 'error');
            }
        }
        
        // ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('ar-SA', options);
        }
        
        function globalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            console.log('Ø¨Ø­Ø« Ø¹Ø§Ù…:', searchTerm);
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div>${message}</div>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
